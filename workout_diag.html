<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Horizon V24 (Final Integrated)</title>
    <style>
        :root {
            --bg: #0f172a; --surface: #1e293b; --primary: #3b82f6;
            --text: #f8fafc; --text-muted: #94a3b8;
            --c-rpm: #10b981; --c-pwr: #f59e0b; --c-spd: #06b6d4; --c-res: #ec4899;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg); color: var(--text);
            margin: 0; padding: 15px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; touch-action: manipulation;
            padding-bottom: 160px; /* Space for Debug Console */
        }

        /* 1. System Error Banner (Top) */
        #sys-error {
            width: 100%; background: #ef4444; color: white; padding: 15px;
            font-weight: bold; text-align: center; display: none; margin-bottom: 20px;
            border-radius: 8px; border: 2px solid white;
        }

        /* 2. Debug Console (Bottom Fixed) */
        #console-log {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 150px;
            background: rgba(0,0,0,0.9); color: #0f0; border-top: 2px solid #555;
            font-size: 11px; padding: 10px; overflow-y: scroll; font-family: monospace;
            z-index: 9999; box-sizing: border-box;
        }

        /* 3. Header */
        .header { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .bt-status { font-size: 12px; color: #64748b; font-weight: bold; }
        .bt-status.connected { color: var(--primary); }

        /* 4. Dashboard (Grid) */
        .dashboard {
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px;
            width: 100%; max-width: 500px; margin-bottom: 20px;
        }
        .mini-card { background: var(--surface); padding: 10px 5px; border-radius: 12px; text-align: center; }
        .mini-val { font-size: 24px; font-weight: 800; line-height: 1; }
        .mini-lbl { font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-top: 2px; }
        .c-rpm { color: var(--c-rpm); } .c-pwr { color: var(--c-pwr); } .c-spd { color: var(--c-spd); } .c-res { color: var(--c-res); }

        /* 5. Global Timer */
        .global-timer-box {
            width: 100%; max-width: 500px; background: #000; border-radius: 16px;
            padding: 15px; margin-bottom: 20px; text-align: center; border: 1px solid #333;
            box-sizing: border-box;
        }
        .total-time-display { font-size: 48px; font-weight: bold; font-family: monospace; color: white; letter-spacing: 2px; }
        .total-label { color: #666; font-size: 12px; margin-top: 5px; }

        /* 6. Phases */
        .phase-container { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
        .phase-card {
            background: var(--surface); border: 2px solid #334155;
            border-radius: 16px; padding: 15px; transition: 0.3s;
        }
        .phase-card.active { border-color: var(--primary); background: #17253d; box-shadow: 0 0 15px rgba(59,130,246,0.2); }
        .phase-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 10px; font-size: 14px; color: var(--text-muted); }
        .phase-card.active .phase-header { color: var(--primary); }
        .phase-timer { font-family: monospace; font-size: 18px; color: white; }

        /* Controls */
        .controls-row { display: flex; justify-content: space-between; gap: 10px; }
        .control-group { 
            background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; flex: 1; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .ctrl-btn {
            width: 36px; height: 36px; border-radius: 50%; border: none;
            background: #475569; color: white; font-size: 20px; cursor: pointer;
        }
        .ctrl-btn:active { background: var(--primary); transform: scale(0.95); }
        .ctrl-val { font-size: 24px; font-weight: 800; min-width: 40px; text-align: center; }
        .ctrl-lbl { font-size: 10px; color: #aaa; margin-bottom: 5px; display:block; text-align:center;}
        .col-center { display:flex; flex-direction:column; align-items:center; }

        /* 7. Action Buttons */
        .action-area { width: 100%; max-width: 500px; display: flex; gap: 10px; margin-bottom: 20px; }
        .main-btn {
            flex: 1; padding: 15px; border-radius: 12px; border: none; 
            font-weight: bold; font-size: 16px; color: white; cursor: pointer;
        }
        #connectBtn { background: var(--primary); width: 100%; max-width: 500px; margin-bottom: 20px; font-size: 20px; padding: 20px; }
        #startBtn { background: #10b981; }
        #stopBtn { background: #ef4444; }

    </style>
    
    <script>
        window.onerror = function(msg, url, line) {
            const errDiv = document.getElementById('sys-error');
            if(errDiv) {
                errDiv.style.display = 'block';
                errDiv.innerHTML = `⚠️ SYSTEM CRASH: ${msg} (Line ${line})`;
            }
            // Also try to log to debug console
            const dbg = document.getElementById('console-log');
            if(dbg) dbg.innerHTML += `<div style="color:red">CRASH: ${msg}</div>`;
        };
    </script>
</head>
<body>

    <div id="sys-error"></div>

    <div class="header">
        <span style="font-weight:bold;">HORIZON V24</span>
        <span id="btStatus" class="bt-status">Disconnected</span>
    </div>

    <button id="connectBtn" onclick="startScan()">1. Scan & Connect (3.0SC)</button>

    <div class="dashboard">
        <div class="mini-card"><div id="rpmVal" class="mini-val c-rpm">0</div><div class="mini-lbl">RPM</div></div>
        <div class="mini-card"><div id="pwrVal" class="mini-val c-pwr">0</div><div class="mini-lbl">WATT</div></div>
        <div class="mini-card"><div id="spdVal" class="mini-val c-spd">0.0</div><div class="mini-lbl">KMH</div></div>
        <div class="mini-card"><div id="resVal" class="mini-val c-res">1</div><div class="mini-lbl">LVL</div></div>
    </div>

    <div class="global-timer-box">
        <div id="globalTimer" class="total-time-display">00:00</div>
        <div id="totalLabel" class="total-label">Total Time</div>
    </div>

    <div class="phase-container">
        
        <div id="card_warmup" class="phase-card">
            <div class="phase-header"><span>WARM UP</span><span id="timer_warmup" class="phase-timer">03:00</span></div>
            <div class="controls-row">
                <div class="control-group">
                    <button class="ctrl-btn" onclick="adjRes('warmup', -1)">-</button>
                    <div class="col-center"><span class="ctrl-lbl">RES</span><span id="val_res_warmup" class="ctrl-val c-res">10</span></div>
                    <button class="ctrl-btn" onclick="adjRes('warmup', 1)">+</button>
                </div>
                <div class="control-group">
                    <button class="ctrl-btn" onclick="adjTime('warmup', -1)">-</button>
                    <div class="col-center"><span class="ctrl-lbl">TIME</span><span id="val_time_warmup" class="ctrl-val">3</span></div>
                    <button class="ctrl-btn" onclick="adjTime('warmup', 1)">+</button>
                </div>
            </div>
        </div>

        <div id="card_workout" class="phase-card">
            <div class="phase-header"><span>WORKOUT</span><span id="timer_workout" class="phase-timer">15:00</span></div>
            <div class="controls-row">
                <div class="control-group">
                    <button class="ctrl-btn" onclick="adjRes('workout', -1)">-</button>
                    <div class="col-center"><span class="ctrl-lbl">RES</span><span id="val_res_workout" class="ctrl-val c-res">24</span></div>
                    <button class="ctrl-btn" onclick="adjRes('workout', 1)">+</button>
                </div>
                <div class="control-group">
                    <button class="ctrl-btn" onclick="adjTime('workout', -1)">-</button>
                    <div class="col-center"><span class="ctrl-lbl">TIME</span><span id="val_time_workout" class="ctrl-val">15</span></div>
                    <button class="ctrl-btn" onclick="adjTime('workout', 1)">+</button>
                </div>
            </div>
        </div>

        <div id="card_cooldown" class="phase-card">
            <div class="phase-header"><span>COOL DOWN</span><span id="timer_cooldown" class="phase-timer">03:00</span></div>
            <div class="controls-row">
                <div class="control-group">
                    <button class="ctrl-btn" onclick="adjRes('cooldown', -1)">-</button>
                    <div class="col-center"><span class="ctrl-lbl">RES</span><span id="val_res_cooldown" class="ctrl-val c-res">10</span></div>
                    <button class="ctrl-btn" onclick="adjRes('cooldown', 1)">+</button>
                </div>
                <div class="control-group">
                    <button class="ctrl-btn" onclick="adjTime('cooldown', -1)">-</button>
                    <div class="col-center"><span class="ctrl-lbl">TIME</span><span id="val_time_cooldown" class="ctrl-val">3</span></div>
                    <button class="ctrl-btn" onclick="adjTime('cooldown', 1)">+</button>
                </div>
            </div>
        </div>

    </div>

    <div class="action-area">
        <button id="startBtn" class="main-btn" onclick="startWorkoutRoutine()">START</button>
        <button id="stopBtn" class="main-btn" onclick="stopWorkout()">STOP</button>
    </div>

    <div id="console-log">V24 Ready. Waiting for user...</div>

<script>
    // 0. Base Utilities
    const logBox = document.getElementById('console-log');
    
    function log(msg) {
        const d = new Date();
        const ts = `${d.getHours()}:${d.getMinutes()}:${d.getSeconds()}`;
        if(logBox) {
            logBox.innerHTML += `<div><span style="color:#666">[${ts}]</span> ${msg}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }
        console.log(msg);
    }

    log("Initializing V24 System...");

    // 1. Bluetooth Constants (FULL UUIDs for iOS Stability)
    const FTMS_UUID = "00001826-0000-1000-8000-00805f9b34fb";
    const DATA_UUID = "00002ad2-0000-1000-8000-00805f9b34fb";
    const CTRL_UUID = "00002ad9-0000-1000-8000-00805f9b34fb";

    // 2. Global State
    let controlChar = null;
    let currentStatus = 'IDLE'; 
    let workoutInterval = null;
    let keeperInterval = null; 
    let lastCmdTime = 0;

    const phases = {
        warmup: { mins: 3, res: 10, remainingSecs: 180 },
        workout: { mins: 15, res: 24, remainingSecs: 900 },
        cooldown: { mins: 3, res: 10, remainingSecs: 180 }
    };

    // 3. UI Elements
    const ui = {
        connectBtn: document.getElementById('connectBtn'),
        btStatus: document.getElementById('btStatus'),
        rpm: document.getElementById('rpmVal'),
        pwr: document.getElementById('pwrVal'),
        spd: document.getElementById('spdVal'),
        res: document.getElementById('resVal'),
        globalTimer: document.getElementById('globalTimer'),
        totalLabel: document.getElementById('totalLabel')
    };

    // Initial Setup
    updateTotalLabel();
    log("UI Loaded. Bluetooth API Check: " + (navigator.bluetooth ? "OK" : "MISSING"));

    // --- Bluetooth Logic (Based on V23 Success) ---

    window.startScan = async function() {
        log(">>> Button: Start Scan");
        
        if (!navigator.bluetooth) {
            log("Error: Web Bluetooth API not found.");
            alert("Error: Please use Bluefy Browser on iPad.");
            return;
        }

        try {
            ui.connectBtn.innerText = "Scanning...";
            
            // Critical: acceptAllDevices + Full UUID is the only stable combo
            log("Requesting Device (acceptAllDevices: true)...");
            const device = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: [FTMS_UUID] 
            });

            log(`Selected: ${device.name}`);
            await connectDevice(device);

        } catch (e) {
            log("Scan Error: " + e);
            // Reset button if cancelled
            if (String(e).includes("cancelled")) {
                 ui.connectBtn.innerText = "1. Scan & Connect (3.0SC)";
            } else {
                 ui.connectBtn.innerText = "Retry Scan";
                 alert("Scan Failed: " + e);
            }
        }
    };

    async function connectDevice(device) {
        try {
            log("Connecting GATT...");
            device.addEventListener('gattserverdisconnected', onDisconnect);
            const server = await device.gatt.connect();
            
            log("Getting Service...");
            const service = await server.getPrimaryService(FTMS_UUID);
            
            log("Getting Characteristics...");
            controlChar = await service.getCharacteristic(CTRL_UUID);
            const dataChar = await service.getCharacteristic(DATA_UUID);
            
            log("Starting Notifications...");
            await dataChar.startNotifications();
            dataChar.addEventListener('characteristicvaluechanged', parseData);

            log("Sending Unlock Codes...");
            await sendHex(0x00);
            await sendHex(0x07);

            log(">>> SUCCESS: Connected! <<<");
            
            // Update UI
            ui.btStatus.innerText = "Connected";
            ui.btStatus.classList.add('connected');
            ui.connectBtn.style.display = 'none'; // Hide button on success

        } catch(e) {
            log("Connection Error: " + e);
            alert("Connection Error: " + e);
            ui.connectBtn.innerText = "Connection Failed";
        }
    }

    // --- Workout Logic ---

    window.startWorkoutRoutine = function() {
        if (currentStatus !== 'IDLE') {
            log("Workout already running.");
            return;
        }
        
        if(!controlChar) {
            log("Warning: Bluetooth not connected. Starting in Demo Mode.");
        }

        log("Starting Routine -> WARMUP");
        
        // Wake up bike just in case
        sendHex(0x07).then(() => {
            startPhase('WARMUP');
        });
    };

    window.stopWorkout = function() {
        clearInterval(workoutInterval);
        clearInterval(keeperInterval);
        currentStatus = 'IDLE';
        document.querySelectorAll('.phase-card').forEach(el => el.classList.remove('active'));
        
        // Reset timers to defaults
        resetTimers();
        updateTotalLabel();
        
        // Drop resistance
        setResistance(1); 
        log("Workout Stopped.");
    };

    function startPhase(phaseName) {
        clearInterval(workoutInterval);
        clearInterval(keeperInterval);
        
        currentStatus = phaseName;
        log(`>>> Phase: ${phaseName}`);
        
        // UI Highlight
        document.querySelectorAll('.phase-card').forEach(el => el.classList.remove('active'));
        let pKey = phaseName.toLowerCase();
        let pData = phases[pKey];
        document.getElementById(`card_${pKey}`).classList.add('active');

        // 1. Send Target Resistance (Double Send Strategy)
        setResistance(pData.res);
        setTimeout(() => setResistance(pData.res), 800);

        // 2. Keeper: Re-send resistance every 3s to prevent bike reset
        keeperInterval = setInterval(() => {
            if (currentStatus === phaseName) {
                // Silent update (internal only)
                setResistanceInternal(phases[pKey].res);
            }
        }, 3000);

        // 3. Timer Loop
        workoutInterval = setInterval(() => tick(pKey), 1000);
    }

    function tick(phaseKey) {
        // Phase Timer
        if (phases[phaseKey].remainingSecs > 0) {
            phases[phaseKey].remainingSecs--;
            document.getElementById(`timer_${phaseKey}`).innerText = formatTime(phases[phaseKey].remainingSecs);
        }
        
        // Calculate Global Time Remaining
        let totalSecs = phases.warmup.remainingSecs + phases.workout.remainingSecs + phases.cooldown.remainingSecs;
        ui.globalTimer.innerText = formatTime(totalSecs);

        // End of Phase Check
        if (phases[phaseKey].remainingSecs <= 0) {
            nextPhase(phaseKey);
        }
    }

    function nextPhase(current) {
        if (current === 'warmup') startPhase('WORKOUT');
        else if (current === 'workout') startPhase('COOLDOWN');
        else if (current === 'cooldown') {
            stopWorkout();
            alert("Workout Complete!");
        }
    }

    // --- Adjust Functions (+/-) ---

    window.adjTime = function(phase, delta) {
        let p = phases[phase];
        p.mins += delta;
        if (p.mins < 1) p.mins = 1;
        
        // Update UI
        document.getElementById(`val_time_${phase}`).innerText = p.mins;
        
        // Only update internal timer if IDLE (to avoid jumping during workout)
        if (currentStatus === 'IDLE') {
            p.remainingSecs = p.mins * 60;
            document.getElementById(`timer_${phase}`).innerText = formatTime(p.remainingSecs);
            updateTotalLabel();
        }
    };

    window.adjRes = function(phase, delta) {
        let p = phases[phase];
        p.res += delta;
        if (p.res < 1) p.res = 1;
        if (p.res > 32) p.res = 32;
        
        // Update UI
        document.getElementById(`val_res_${phase}`).innerText = p.res;
        
        // If we are currently in this phase, apply immediately
        if (currentStatus === phase.toUpperCase()) {
            setResistance(p.res);
        }
    };

    function resetTimers() {
        for (let key in phases) {
            let p = phases[key];
            p.remainingSecs = p.mins * 60;
            document.getElementById(`timer_${key}`).innerText = formatTime(p.remainingSecs);
        }
        ui.globalTimer.innerText = "00:00";
    }

    function updateTotalLabel() {
        let total = phases.warmup.mins + phases.workout.mins + phases.cooldown.mins;
        ui.totalLabel.innerText = `Total: ${total} Mins`;
    }

    function formatTime(sec) {
        let m = Math.floor(sec / 60);
        let s = sec % 60;
        return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    // --- Helper Functions ---

    async function setResistance(val) {
        val = parseInt(val);
        // Update UI immediately (Optimistic UI)
        if(ui.res) ui.res.innerText = val; 
        lastCmdTime = Date.now(); // Mark time to ignore old data
        
        log(`Set Resistance: ${val}`);
        await setResistanceInternal(val);
    }

    async function setResistanceInternal(val) {
        if (!controlChar) return;
        const target = val * 10;
        const buffer = new ArrayBuffer(3);
        const view = new DataView(buffer);
        view.setUint8(0, 0x04);
        view.setUint16(1, target, true);
        try { await controlChar.writeValue(buffer); } catch(e) { /* Ignore silent errors in keeper */ }
    }

    async function sendHex(byte) {
        if(controlChar) await controlChar.writeValue(new Uint8Array([byte])).catch(()=>{});
    }

    function parseData(event) {
        const val = event.target.value;
        const flags = val.getUint16(0, true);
        let offset = 2;

        // Flags parsing according to FTMS
        // Bit 0: Speed
        if ((flags & 0x01) === 0) { 
            ui.spd.innerText = (val.getUint16(offset, true) * 0.01).toFixed(1);
            offset += 2;
        }
        // Bit 1: Avg Speed
        if (flags & 0x02) offset += 2;
        // Bit 2: Cadence
        if (flags & 0x04) { 
            ui.rpm.innerText = Math.floor(val.getUint16(offset, true) * 0.5);
            offset += 2;
        }
        // Bit 3: Avg Cadence
        if (flags & 0x08) offset += 2;
        // Bit 4: Distance
        if (flags & 0x10) offset += 3;
        
        // Bit 5: Resistance
        if (flags & 0x20) { 
            const r = val.getInt16(offset, true);
            // UI Lock: Only update if we haven't sent a command recently (3s)
            // This prevents the slider from jumping back to old values
            if (r > 0) {
                if (Date.now() - lastCmdTime > 3000) {
                    ui.res.innerText = r;
                }
            }
            offset += 2;
        }
        
        // Bit 6: Power
        if (flags & 0x40) { 
            ui.pwr.innerText = val.getInt16(offset, true);
            offset += 2;
        }
    }

    function onDisconnect() {
        ui.btStatus.innerText = "Disconnected";
        ui.btStatus.classList.remove('connected');
        ui.connectBtn.style.display = 'block';
        ui.connectBtn.innerText = "Re-Connect";
        
        stopWorkout();
        log("!!! DISCONNECTED !!!");
        alert("Bike Disconnected");
    }
</script>
</body>
</html>
