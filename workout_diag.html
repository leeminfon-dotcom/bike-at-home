<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V13 System Check</title>
    <style>
        body { font-family: monospace; background: #000; color: #fff; padding: 20px; max-width: 600px; margin: 0 auto; }
        h3 { border-bottom: 1px solid #555; padding-bottom: 10px; color: #3b82f6; }
        
        /* 測試按鈕區 */
        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        button { font-size: 16px; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #btnA { background: #10b981; color: white; } /* 綠 */
        #btnB { background: #f59e0b; color: black; } /* 黃 */
        #btnC { background: #ef4444; color: white; } /* 紅 */
        
        /* 螢幕日誌區 */
        #console { 
            width: 100%; height: 300px; 
            background: #111; border: 1px solid #333; 
            color: #0f0; padding: 10px; 
            overflow-y: scroll; font-size: 13px; 
            white-space: pre-wrap; box-sizing: border-box;
        }
    </style>
</head>
<body>

    <h3>V13 藍牙連線檢測工具</h3>

    <div id="statusArea">正在載入 JS...</div>

    <div class="btn-group">
        <button id="btnA" onclick="testConnection('A')">策略 A: 搜尋名稱 "3.0SC"</button>
        <button id="btnB" onclick="testConnection('B')">策略 B: 搜尋服務 FTMS</button>
        <button id="btnC" onclick="testConnection('C')">策略 C: 掃描全部 (寬鬆)</button>
    </div>

    <label>系統日誌 (System Log):</label>
    <div id="console"></div>

<script>
    // 1. 初始化日誌系統
    const logBox = document.getElementById('console');
    const statusArea = document.getElementById('statusArea');

    function log(msg, type='info') {
        const t = new Date().toLocaleTimeString();
        let color = '#0f0';
        if(type==='error') color = '#f55';
        if(type==='warn') color = '#ff0';
        
        logBox.innerHTML += `<div style="color:${color}">[${t}] ${msg}</div>`;
        logBox.scrollTop = logBox.scrollHeight;
        console.log(msg);
    }

    // 2. 錯誤捕捉 (全域)
    window.onerror = function(msg, url, line) {
        log(`CRITICAL ERROR: ${msg} (Line: ${line})`, 'error');
        return false;
    };

    // 3. 環境檢查 (立即執行)
    log("--- 系統啟動 ---");
    
    // 檢查 HTTPS
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        log("警告: 非 HTTPS 環境，Web Bluetooth 將無法運作！", 'error');
        statusArea.innerText = "環境錯誤: 請使用 HTTPS";
    } else {
        log("環境檢查: HTTPS/Localhost OK");
    }

    // 檢查 API 支援
    if (!navigator.bluetooth) {
        log("錯誤: 瀏覽器不支援 navigator.bluetooth", 'error');
        log("PC 請用 Chrome/Edge，iPad 請用 Bluefy", 'warn');
        statusArea.innerText = "瀏覽器不支援";
    } else {
        log("API 檢查: Bluetooth API 存在 (OK)");
        statusArea.innerText = "系統就緒，請點擊按鈕測試";
    }

    // 4. 連線邏輯
    const FTMS_UUID = 0x1826;
    const CTRL_UUID = 0x2AD9;

    async function testConnection(strategy) {
        log(`\n>>> 啟動策略 ${strategy}...`);
        
        try {
            let options = {};
            
            // 不同的掃描參數
            if (strategy === 'A') {
                log("設定: filters name = '3.0SC'");
                options = { 
                    filters: [{ name: "3.0SC" }],
                    optionalServices: [FTMS_UUID]
                };
            } 
            else if (strategy === 'B') {
                log("設定: filters services = [0x1826]");
                options = { 
                    filters: [{ services: [FTMS_UUID] }],
                    optionalServices: [FTMS_UUID]
                };
            } 
            else if (strategy === 'C') {
                log("設定: acceptAllDevices = true");
                options = { 
                    acceptAllDevices: true,
                    optionalServices: [FTMS_UUID]
                };
            }

            log("正在呼叫 navigator.bluetooth.requestDevice...");
            
            const device = await navigator.bluetooth.requestDevice(options);
            
            log(`成功選取裝置: ${device.name} (ID: ${device.id})`, 'warn');
            log("正在連線 GATT Server...");
            
            const server = await device.gatt.connect();
            log("GATT 連線成功！");
            
            log("正在取得 FTMS 服務...");
            const service = await server.getPrimaryService(FTMS_UUID);
            log("服務取得成功！");

            log("正在取得 Control Point...");
            const char = await service.getCharacteristic(CTRL_UUID);
            log("特徵值取得成功！測試完成。");
            
            alert(`連線成功！\n裝置: ${device.name}\n策略 ${strategy} 有效。`);

        } catch (e) {
            log(`連線失敗: ${e.message || e}`, 'error');
            log("完整錯誤物件: " + JSON.stringify(e));
        }
    }
</script>
</body>
</html>
