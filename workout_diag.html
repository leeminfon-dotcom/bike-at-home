<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Horizon V29 (Safety)</title>
    <style>
        :root { --bg: #0f172a; --surface: #1e293b; --primary: #3b82f6; --text: #f8fafc; }
        body {
            font-family: monospace, sans-serif; background: var(--bg); color: var(--text);
            margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; padding-bottom: 200px;
        }

        /* Debug Console */
        #console-log {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 180px;
            background: #000; color: #0f0; border-top: 2px solid #555;
            font-size: 11px; padding: 10px; overflow-y: scroll;
            z-index: 9999; box-sizing: border-box; text-align: left;
        }

        /* Layout */
        .header { width: 100%; max-width: 500px; display: flex; justify-content: space-between; margin-bottom: 10px; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; width: 100%; max-width: 500px; margin-bottom: 15px; }
        .mini-card { background: var(--surface); padding: 10px 5px; border-radius: 8px; text-align: center; }
        .mini-val { font-size: 20px; font-weight: bold; }
        .mini-lbl { font-size: 10px; color: #94a3b8; }
        
        .global-timer { background: #000; width: 100%; max-width: 500px; border-radius: 12px; padding: 10px; text-align: center; border: 1px solid #333; margin-bottom: 15px; }
        .time-big { font-size: 40px; font-weight: bold; color: white; }

        /* Phases */
        .phase-box { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .p-card { background: var(--surface); border: 1px solid #334155; padding: 10px; border-radius: 10px; }
        .p-card.active { border: 2px solid var(--primary); background: #17253d; }
        .p-head { display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        
        /* Controls */
        .ctrl-row { display: flex; justify-content: space-between; gap: 10px; }
        .ctrl-grp { background: rgba(0,0,0,0.3); padding: 5px; border-radius: 8px; flex: 1; display: flex; justify-content: space-between; align-items: center; }
        .c-btn { width: 30px; height: 30px; border-radius: 50%; border: none; background: #475569; color: white; font-size: 18px; font-weight: bold; }
        .c-val { font-size: 18px; font-weight: bold; min-width: 30px; text-align: center; }
        
        /* Main Buttons */
        .top-btns { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .row-btns { display: flex; gap: 10px; }
        .btn-big { flex: 1; padding: 15px; border-radius: 10px; border: none; font-size: 18px; font-weight: bold; color: white; }
        #btn-scan { background: var(--primary); width: 100%; }
        #btn-start { background: #10b981; }
        #btn-stop { background: #ef4444; }
    </style>

    <script>
        window.onerror = function(msg, url, line) {
            var dbg = document.getElementById('console-log');
            if(dbg) dbg.innerHTML += '<div style="color:red">ERROR: ' + msg + ' (Line ' + line + ')</div>';
        };
        function log(msg) {
            var dbg = document.getElementById('console-log');
            if(dbg) {
                var t = new Date().toTimeString().split(' ')[0];
                dbg.innerHTML += '<div><span style="color:#666">[' + t + ']</span> ' + msg + '</div>';
                dbg.scrollTop = dbg.scrollHeight;
            }
            console.log(msg);
        }
    </script>
</head>
<body>

    <div class="header">
        <strong>HORIZON V29</strong>
        <span id="status">Disconnected</span>
    </div>

    <div class="top-btns">
        <button id="btn-scan" class="btn-big">1. Connect Bike</button>
        <div class="row-btns">
            <button id="btn-start" class="btn-big">START</button>
            <button id="btn-stop" class="btn-big">STOP</button>
        </div>
    </div>

    <div class="dashboard">
        <div class="mini-card"><div id="d-rpm" class="mini-val" style="color:#10b981">0</div><div class="mini-lbl">RPM</div></div>
        <div class="mini-card"><div id="d-watt" class="mini-val" style="color:#f59e0b">0</div><div class="mini-lbl">WATT</div></div>
        <div class="mini-card"><div id="d-spd" class="mini-val" style="color:#06b6d4">0.0</div><div class="mini-lbl">KMH</div></div>
        <div class="mini-card"><div id="d-lvl" class="mini-val" style="color:#ec4899">1</div><div class="mini-lbl">LEVEL</div></div>
    </div>

    <div class="global-timer">
        <div id="g-time" class="time-big">00:00</div>
        <div id="g-label" style="font-size:12px; color:#888;">Total Time</div>
    </div>

    <div id="phase-wrapper" class="phase-box">
        </div>

    <div id="console-log">V29 Booting...</div>

<script>
    // --- 1. SAFE VARIABLES ---
    log("1. Init Constants...");
    var FTMS_UUID = "00001826-0000-1000-8000-00805f9b34fb";
    var DATA_UUID = "00002ad2-0000-1000-8000-00805f9b34fb";
    var CTRL_UUID = "00002ad9-0000-1000-8000-00805f9b34fb";
    
    var controlChar = null;
    var currentStatus = 'IDLE'; 
    var intervals = { work: null, keep: null };
    
    // Default Data
    var phaseData = {
        'p1': { name: 'WARM UP',   mins: 3,  lvl: 10, sec: 180 },
        'p2': { name: 'WORKOUT 1', mins: 15, lvl: 24, sec: 900 },
        'p3': { name: 'WORKOUT 2', mins: 10, lvl: 20, sec: 600 },
        'p4': { name: 'COOL DOWN', mins: 3,  lvl: 10, sec: 180 }
    };
    var phaseOrder = ['p1', 'p2', 'p3', 'p4'];

    // --- 2. HTML GENERATOR (To ensure IDs exist) ---
    log("2. Generating UI...");
    var wrapper = document.getElementById('phase-wrapper');
    if(!wrapper) log("ERROR: Wrapper not found");
    
    phaseOrder.forEach(function(key) {
        var p = phaseData[key];
        var html = 
        '<div id="card_'+key+'" class="p-card">' +
            '<div class="p-head"><span>'+p.name+'</span><span id="t_'+key+'">00:00</span></div>' +
            '<div class="ctrl-row">' +
                '<div class="ctrl-grp">' +
                    '<button class="c-btn" onclick="userAdj(\''+key+'\', \'lvl\', -1)">-</button>' +
                    '<div style="text-align:center"><div style="font-size:10px;color:#aaa">LEVEL</div><span id="v_lvl_'+key+'" class="c-val">'+p.lvl+'</span></div>' +
                    '<button class="c-btn" onclick="userAdj(\''+key+'\', \'lvl\', 1)">+</button>' +
                '</div>' +
                '<div class="ctrl-grp">' +
                    '<button class="c-btn" onclick="userAdj(\''+key+'\', \'min\', -1)">-</button>' +
                    '<div style="text-align:center"><div style="font-size:10px;color:#aaa">TIME</div><span id="v_min_'+key+'" class="c-val">'+p.mins+'</span></div>' +
                    '<button class="c-btn" onclick="userAdj(\''+key+'\', \'min\', 1)">+</button>' +
                '</div>' +
            '</div>' +
        '</div>';
        wrapper.innerHTML += html;
    });

    // --- 3. STORAGE (SAFE MODE) ---
    log("3. Loading Memory...");
    try {
        var saved = localStorage.getItem('horizon_v29_data');
        if(saved) {
            var parsed = JSON.parse(saved);
            for(var k in parsed) {
                if(phaseData[k]) {
                    phaseData[k].mins = parsed[k].mins;
                    phaseData[k].lvl = parsed[k].lvl;
                    phaseData[k].sec = parsed[k].mins * 60;
                }
            }
            log("Memory Loaded.");
        }
    } catch(e) {
        log("Memory Error (Private Mode?): " + e.message);
    }
    refreshUI();

    // --- 4. BINDINGS ---
    log("4. Binding Buttons...");
    try {
        document.getElementById('btn-scan').addEventListener('click', startScan);
        document.getElementById('btn-start').addEventListener('click', startRoutine);
        document.getElementById('btn-stop').addEventListener('click', stopAll);
    } catch(e) {
        log("Binding Error: " + e.message);
    }

    log(">>> SYSTEM READY <<<");

    // --- FUNCTIONS ---

    function userAdj(key, type, delta) {
        var p = phaseData[key];
        if(type === 'lvl') {
            p.lvl += delta;
            if(p.lvl < 1) p.lvl = 1;
            if(p.lvl > 32) p.lvl = 32;
            // Immediate update if running
            if(currentStatus === key) setLevel(p.lvl);
        } else {
            p.mins += delta;
            if(p.mins < 1) p.mins = 1;
            // Only update timer if not running this phase
            if(currentStatus === 'IDLE') p.sec = p.mins * 60;
        }
        refreshUI();
    }

    function refreshUI() {
        var totalMin = 0;
        phaseOrder.forEach(function(key) {
            var p = phaseData[key];
            document.getElementById('v_lvl_'+key).innerText = p.lvl;
            document.getElementById('v_min_'+key).innerText = p.mins;
            document.getElementById('t_'+key).innerText = fmt(p.sec);
            totalMin += p.mins;
        });
        document.getElementById('g-label').innerText = "Total: " + totalMin + " Mins";
        
        if(currentStatus === 'IDLE') {
            document.getElementById('g-time').innerText = fmt(totalMin * 60);
        }
    }

    function saveMem() {
        try {
            var s = {};
            for(var k in phaseData) s[k] = { mins: phaseData[k].mins, lvl: phaseData[k].lvl };
            localStorage.setItem('horizon_v29_data', JSON.stringify(s));
        } catch(e) {}
    }

    // --- BLUETOOTH ---

    async function startScan() {
        log("Scan Clicked.");
        if(!navigator.bluetooth) return alert("No Bluetooth API");
        
        var btn = document.getElementById('btn-scan');
        btn.innerText = "Scanning...";

        try {
            // Auto Connect Check
            try {
                var lastId = localStorage.getItem('horizon_v29_dev');
                if(lastId && navigator.bluetooth.getDevices) {
                    var devs = await navigator.bluetooth.getDevices();
                    var match = devs.find(function(d) { return d.id === lastId; });
                    if(match) {
                        log("Auto-connecting to: " + match.name);
                        return doConnect(match);
                    }
                }
            } catch(e) {}

            // Manual Scan
            log("Opening Scanner...");
            var dev = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: [FTMS_UUID]
            });
            try { localStorage.setItem('horizon_v29_dev', dev.id); } catch(e){}
            doConnect
